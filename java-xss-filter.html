<!-- build time:Tue Nov 05 2019 23:20:54 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script></script><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="-ZrQ5_gvorSDz6GoISTGIBaTjef2c3TFVkPfrA3d3XQ"><meta name="yandex-verification" content="be23233c5033cd4a"><meta name="baidu-site-verification" content="KFXVdNKQ18"><meta name="360-site-verification" content="bbd6f1a0727d8ef429be7131a051be20"><meta name="shenma-site-verification" content="719fb1b0c8f713194c5ac0387ee88673_1519303685"><meta name="msvalidate.01" content="EA3043B3BEC4629344CE5A71597718A0"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="1075199251,张凯,18772383543,wuwii,追光者w,有梦想的咸鱼,一棵树站在原野上,Slience"><link rel="alternate" href="/atom.xml" title="My Sunshine" type="application/atom+xml"><meta name="description" content="关于XSS攻击XSS是一种经常出现在web应用中的计算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中。"><meta name="keywords" content="1075199251,张凯,18772383543,wuwii,追光者w,有梦想的咸鱼,一棵树站在原野上,Slience"><meta property="og:type" content="article"><meta property="og:title" content="XSS攻击过滤处理"><meta property="og:url" content="http://blog.wuwii.com/java-xss-filter.html"><meta property="og:site_name" content="My Sunshine"><meta property="og:description" content="关于XSS攻击XSS是一种经常出现在web应用中的计算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中。"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2018-06-18T13:25:59.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="XSS攻击过滤处理"><meta name="twitter:description" content="关于XSS攻击XSS是一种经常出现在web应用中的计算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中。"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"left",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"TWXZ15WRBL",apiKey:"c272bd4b810c8b43773a3f1d3c6b8d27",indexName:"wuwii",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://blog.wuwii.com/java-xss-filter.html"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#1f94aa"><title>XSS攻击过滤处理 | My Sunshine</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b847762b9271725a63131e554978de0a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(){var e=document.createElement("script");e.src="//tajs.qq.com/stats?sId=63798915";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link href="https://zqnight.gitee.io/kaimz.github.io/css/harlem-shake-style.css" rel="stylesheet" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><div class="forkme"><a rel="external nofollow noopener noreferrer" href="https://github.com/kaimz" target="_blank"><img style="position:absolute;top:0;left:0;border:0" src="https://s3.amazonaws.com/github/ribbons/forkme_left_white_ffffff.png" alt="Fork me on GitHub"></a></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">My Sunshine</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">鸣谢生命有你参与 笑纳我的邀请。</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav><canvas id="wobblew" width="1056" height="150" style="position:absolute;z-index:-1;left:0;top:0"></canvas></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.wuwii.com/java-xss-filter.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Kai Zhang"><meta itemprop="description" content=""><meta itemprop="image" content="http://oss.wuwii.com/image/head/%E6%97%A0%E9%99%90.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="My Sunshine"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">XSS攻击过滤处理</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-14T10:28:03+08:00">2017-12-14 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计</span> <span title="字数统计">3,728 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长</span> <span title="阅读时长">22</span></div></div></header><div class="post-body" itemprop="articleBody"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="关于XSS攻击"><a href="#关于XSS攻击" class="headerlink" title="关于XSS攻击"></a>关于XSS攻击</h3><p>XSS是一种经常出现在web应用中的计算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中。</p><a id="more"></a><h3 id="XSS漏洞的危害"><a href="#XSS漏洞的危害" class="headerlink" title="XSS漏洞的危害"></a>XSS漏洞的危害</h3><ol><li>网络钓鱼，包括盗取各类用户账号；</li><li>窃取用户cookies资料，从而获取用户隐私信息，或利用用户身份进一步对网站执行操作；</li><li>劫持用户（浏览器）会话，从而执行任意操作，例如进行非法转账、强制发表日志、发送电子邮件等；</li><li>强制弹出广告页面、刷流量等；</li><li>网页挂马；</li><li>进行恶意操作，例如任意篡改页面信息、删除文章等；</li><li>进行大量的客户端攻击，如DDoS攻击；</li><li>获取客户端信息，例如用户的浏览历史、真实IP、开放端口等；</li><li>控制受害者机器向其他网站发起攻击；</li><li>结合其他漏洞，如CSRF漏洞，实施进一步作恶；</li><li>提升用户权限，包括进一步渗透网站；</li><li>传播跨站脚本蠕虫等；<br>……</li></ol><h3 id="避免XSS攻击"><a href="#避免XSS攻击" class="headerlink" title="避免XSS攻击"></a>避免XSS攻击</h3><p>XSS类似SQL 注入攻击，都是通过客户端恶意植入，一样也是用过滤器进行过滤。</p><p>框架使用的是SpringMVC。</p><h4 id="XSS过滤器"><a href="#XSS过滤器" class="headerlink" title="XSS过滤器"></a>XSS过滤器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.devframe.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * XSS过滤器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhang Kai</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> &lt;pre&gt;2017/12/14 10:00&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XssFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig config)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        XssHttpServletRequestWrapper xssRequest = <span class="keyword">new</span> XssHttpServletRequestWrapper(</span><br><span class="line">                (HttpServletRequest) request);</span><br><span class="line">        chain.doFilter(xssRequest, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="request进行XSS过滤"><a href="#request进行XSS过滤" class="headerlink" title="request进行XSS过滤"></a>request进行XSS过滤</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.devframe.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ReadListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * XSS过滤处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhang Kai</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> &lt;pre&gt;2017/12/14 9:33&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XssHttpServletRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 没被包装过的HttpServletRequest（特殊场景，需要自己过滤）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest orgRequest;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * html过滤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> HTMLFilter HTML_FILTER = <span class="keyword">new</span> HTMLFilter();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a request object wrapping the given request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the request is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    XssHttpServletRequestWrapper(HttpServletRequest request) <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        orgRequest = request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//非json类型，直接返回</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">super</span>.getHeader(HttpHeaders.CONTENT_TYPE).equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getInputStream();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为空，直接返回</span></span><br><span class="line">        String json = IOUtils.toString(<span class="keyword">super</span>.getInputStream(), <span class="string">"utf-8"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getInputStream();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//xss过滤</span></span><br><span class="line">        json = xssEncode(json);</span><br><span class="line">        <span class="keyword">final</span> ByteArrayInputStream bis = <span class="keyword">new</span> ByteArrayInputStream(json.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadListener</span><span class="params">(ReadListener readListener)</span> </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> bis.read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 参数name，也要过滤</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        String value = <span class="keyword">super</span>.getParameter(xssEncode(name));</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(value)) &#123;</span><br><span class="line">            value = xssEncode(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤参数，值为数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 参数名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getParameterValues(String name) &#123;</span><br><span class="line">        String[] parameters = <span class="keyword">super</span>.getParameterValues(name);</span><br><span class="line">        <span class="keyword">if</span> (parameters == <span class="keyword">null</span> || parameters.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</span><br><span class="line">            parameters[i] = xssEncode(parameters[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> parameters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤参数，返回键值对形式的参数类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String,String[]&gt; getParameterMap() &#123;</span><br><span class="line">        Map&lt;String,String[]&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        Map&lt;String,String[]&gt; parameters = <span class="keyword">super</span>.getParameterMap();</span><br><span class="line">        <span class="keyword">for</span> (String key : parameters.keySet()) &#123;</span><br><span class="line">            String[] values = parameters.get(key);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">                values[i] = xssEncode(values[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            map.put(key, values);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取request的头属性，并且进行xss过滤，返回它的值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 属性名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHeader</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        String value = <span class="keyword">super</span>.getHeader(xssEncode(name));</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(value)) &#123;</span><br><span class="line">            value = xssEncode(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">xssEncode</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HTML_FILTER.filter(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取最原始的request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> HttpServletRequest 原始的request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpServletRequest <span class="title">getOrgRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orgRequest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取最原始的request，明确不进行xss过滤的</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> HttpServletRequest 原始request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpServletRequest <span class="title">getOrgRequest</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> XssHttpServletRequestWrapper) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((XssHttpServletRequestWrapper) request).getOrgRequest();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="XSS过滤工具类"><a href="#XSS过滤工具类" class="headerlink" title="XSS过滤工具类"></a>XSS过滤工具类</h4><p>这个是网上看到直接copy过来，肯定比自己写的全面多了，好东西。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.devframe.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * HTML filtering utility for protecting against XSS (Cross Site Scripting).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This code is licensed LGPLv3</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This code is a Java port of the original work in PHP by Cal Hendersen.</span></span><br><span class="line"><span class="comment"> * http://code.iamcal.com/php/lib_filter/</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The trickiest part of the translation was handling the differences in regex handling</span></span><br><span class="line"><span class="comment"> * between PHP and Java.  These resources were helpful in the process:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * http://java.sun.com/j2se/1.4.2/docs/api/java/util/regex/Pattern.html</span></span><br><span class="line"><span class="comment"> * http://us2.php.net/manual/en/reference.pcre.pattern.modifiers.php</span></span><br><span class="line"><span class="comment"> * http://www.regular-expressions.info/modifiers.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A note on naming conventions: instance variables are prefixed with a "v"; global</span></span><br><span class="line"><span class="comment"> * constants are in all caps.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Sample use:</span></span><br><span class="line"><span class="comment"> * String input = ...</span></span><br><span class="line"><span class="comment"> * String clean = new HTMLFilter().filter( input );</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The class is not thread safe. Create a new instance if in doubt.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If you find bugs or have suggestions on improvement (especially regarding</span></span><br><span class="line"><span class="comment"> * performance), please contact us.  The latest version of this</span></span><br><span class="line"><span class="comment"> * source, and our contact details, can be found at http://xss-html-filter.sf.net</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Joseph O'Connell</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Cal Hendersen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Michael Semb Wever</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HTMLFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** regex flag union representing /si modifiers in php **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REGEX_FLAGS_SI = Pattern.CASE_INSENSITIVE | Pattern.DOTALL;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_COMMENTS = Pattern.compile(<span class="string">"&lt;!--(.*?)--&gt;"</span>, Pattern.DOTALL);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_COMMENT = Pattern.compile(<span class="string">"^!--(.*)--$"</span>, REGEX_FLAGS_SI);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_TAGS = Pattern.compile(<span class="string">"&lt;(.*?)&gt;"</span>, Pattern.DOTALL);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_END_TAG = Pattern.compile(<span class="string">"^/([a-z0-9]+)"</span>, REGEX_FLAGS_SI);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_START_TAG = Pattern.compile(<span class="string">"^([a-z0-9]+)(.*?)(/?)$"</span>, REGEX_FLAGS_SI);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_QUOTED_ATTRIBUTES = Pattern.compile(<span class="string">"([a-z0-9]+)=([\"'])(.*?)\\2"</span>, REGEX_FLAGS_SI);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_UNQUOTED_ATTRIBUTES = Pattern.compile(<span class="string">"([a-z0-9]+)(=)([^\"\\s']+)"</span>, REGEX_FLAGS_SI);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_PROTOCOL = Pattern.compile(<span class="string">"^([^:]+):"</span>, REGEX_FLAGS_SI);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_ENTITY = Pattern.compile(<span class="string">"&amp;#(\\d+);?"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_ENTITY_UNICODE = Pattern.compile(<span class="string">"&amp;#x([0-9a-f]+);?"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_ENCODE = Pattern.compile(<span class="string">"%([0-9a-f]&#123;2&#125;);?"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_VALID_ENTITIES = Pattern.compile(<span class="string">"&amp;([^&amp;;]*)(?=(;|&amp;|$))"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_VALID_QUOTES = Pattern.compile(<span class="string">"(&gt;|^)([^&lt;]+?)(&lt;|$)"</span>, Pattern.DOTALL);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_END_ARROW = Pattern.compile(<span class="string">"^&gt;"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_BODY_TO_END = Pattern.compile(<span class="string">"&lt;([^&gt;]*?)(?=&lt;|$)"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_XML_CONTENT = Pattern.compile(<span class="string">"(^|&gt;)([^&lt;]*?)(?=&gt;)"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_STRAY_LEFT_ARROW = Pattern.compile(<span class="string">"&lt;([^&gt;]*?)(?=&lt;|$)"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_STRAY_RIGHT_ARROW = Pattern.compile(<span class="string">"(^|&gt;)([^&lt;]*?)(?=&gt;)"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_AMP = Pattern.compile(<span class="string">"&amp;"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_QUOTE = Pattern.compile(<span class="string">"&lt;"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_LEFT_ARROW = Pattern.compile(<span class="string">"&lt;"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_RIGHT_ARROW = Pattern.compile(<span class="string">"&gt;"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern P_BOTH_ARROWS = Pattern.compile(<span class="string">"&lt;&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @xxx could grow large... maybe use sesat's ReferenceMap</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;String,Pattern&gt; P_REMOVE_PAIR_BLANKS = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Pattern&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;String,Pattern&gt; P_REMOVE_SELF_BLANKS = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Pattern&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** set of allowed html elements, along with allowed attributes for each element **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;String&gt;&gt; vAllowed;</span><br><span class="line">    <span class="comment">/** counts of open tags for each (allowable) html element **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; vTagCounts = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** html elements which must always be self-closing (e.g. "&lt;img /&gt;") **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] vSelfClosingTags;</span><br><span class="line">    <span class="comment">/** html elements which must always have separate opening and closing tags (e.g. "&lt;b&gt;&lt;/b&gt;") **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] vNeedClosingTags;</span><br><span class="line">    <span class="comment">/** set of disallowed html elements **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] vDisallowed;</span><br><span class="line">    <span class="comment">/** attributes which should be checked for valid protocols **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] vProtocolAtts;</span><br><span class="line">    <span class="comment">/** allowed protocols **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] vAllowedProtocols;</span><br><span class="line">    <span class="comment">/** tags which should be removed if they contain no content (e.g. "&lt;b&gt;&lt;/b&gt;" or "&lt;b /&gt;") **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] vRemoveBlanks;</span><br><span class="line">    <span class="comment">/** entities allowed within html markup **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] vAllowedEntities;</span><br><span class="line">    <span class="comment">/** flag determining whether comments are allowed in input String. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> stripComment;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> encodeQuotes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> vDebug = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * flag determining whether to try to make tags when presented with "unbalanced"</span></span><br><span class="line"><span class="comment">     * angle brackets (e.g. "&lt;b text &lt;/b&gt;" becomes "&lt;b&gt; text &lt;/b&gt;").  If set to false,</span></span><br><span class="line"><span class="comment">     * unbalanced angle brackets will be html escaped.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> alwaysMakeTags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Default constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HTMLFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        vAllowed = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;String&gt; a_atts = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        a_atts.add(<span class="string">"href"</span>);</span><br><span class="line">        a_atts.add(<span class="string">"target"</span>);</span><br><span class="line">        vAllowed.put(<span class="string">"a"</span>, a_atts);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;String&gt; img_atts = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        img_atts.add(<span class="string">"src"</span>);</span><br><span class="line">        img_atts.add(<span class="string">"width"</span>);</span><br><span class="line">        img_atts.add(<span class="string">"height"</span>);</span><br><span class="line">        img_atts.add(<span class="string">"alt"</span>);</span><br><span class="line">        vAllowed.put(<span class="string">"img"</span>, img_atts);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;String&gt; no_atts = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        vAllowed.put(<span class="string">"b"</span>, no_atts);</span><br><span class="line">        vAllowed.put(<span class="string">"strong"</span>, no_atts);</span><br><span class="line">        vAllowed.put(<span class="string">"i"</span>, no_atts);</span><br><span class="line">        vAllowed.put(<span class="string">"em"</span>, no_atts);</span><br><span class="line"></span><br><span class="line">        vSelfClosingTags = <span class="keyword">new</span> String[]&#123;<span class="string">"img"</span>&#125;;</span><br><span class="line">        vNeedClosingTags = <span class="keyword">new</span> String[]&#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"strong"</span>, <span class="string">"i"</span>, <span class="string">"em"</span>&#125;;</span><br><span class="line">        vDisallowed = <span class="keyword">new</span> String[]&#123;&#125;;</span><br><span class="line">        vAllowedProtocols = <span class="keyword">new</span> String[]&#123;<span class="string">"http"</span>, <span class="string">"mailto"</span>, <span class="string">"https"</span>&#125;; <span class="comment">// no ftp.</span></span><br><span class="line">        vProtocolAtts = <span class="keyword">new</span> String[]&#123;<span class="string">"src"</span>, <span class="string">"href"</span>&#125;;</span><br><span class="line">        vRemoveBlanks = <span class="keyword">new</span> String[]&#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"strong"</span>, <span class="string">"i"</span>, <span class="string">"em"</span>&#125;;</span><br><span class="line">        vAllowedEntities = <span class="keyword">new</span> String[]&#123;<span class="string">"amp"</span>, <span class="string">"gt"</span>, <span class="string">"lt"</span>, <span class="string">"quot"</span>&#125;;</span><br><span class="line">        stripComment = <span class="keyword">true</span>;</span><br><span class="line">        encodeQuotes = <span class="keyword">true</span>;</span><br><span class="line">        alwaysMakeTags = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Set debug flag to true. Otherwise use default settings. See the default constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> debug turn debug on with a true argument</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HTMLFilter</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> debug)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>();</span><br><span class="line">        vDebug = debug;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Map-parameter configurable constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conf map containing configuration. keys match field names.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HTMLFilter</span><span class="params">(<span class="keyword">final</span> Map&lt;String,Object&gt; conf)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> conf.containsKey(<span class="string">"vAllowed"</span>) : <span class="string">"configuration requires vAllowed"</span>;</span><br><span class="line">        <span class="keyword">assert</span> conf.containsKey(<span class="string">"vSelfClosingTags"</span>) : <span class="string">"configuration requires vSelfClosingTags"</span>;</span><br><span class="line">        <span class="keyword">assert</span> conf.containsKey(<span class="string">"vNeedClosingTags"</span>) : <span class="string">"configuration requires vNeedClosingTags"</span>;</span><br><span class="line">        <span class="keyword">assert</span> conf.containsKey(<span class="string">"vDisallowed"</span>) : <span class="string">"configuration requires vDisallowed"</span>;</span><br><span class="line">        <span class="keyword">assert</span> conf.containsKey(<span class="string">"vAllowedProtocols"</span>) : <span class="string">"configuration requires vAllowedProtocols"</span>;</span><br><span class="line">        <span class="keyword">assert</span> conf.containsKey(<span class="string">"vProtocolAtts"</span>) : <span class="string">"configuration requires vProtocolAtts"</span>;</span><br><span class="line">        <span class="keyword">assert</span> conf.containsKey(<span class="string">"vRemoveBlanks"</span>) : <span class="string">"configuration requires vRemoveBlanks"</span>;</span><br><span class="line">        <span class="keyword">assert</span> conf.containsKey(<span class="string">"vAllowedEntities"</span>) : <span class="string">"configuration requires vAllowedEntities"</span>;</span><br><span class="line"></span><br><span class="line">        vAllowed = Collections.unmodifiableMap((HashMap&lt;String, List&lt;String&gt;&gt;) conf.get(<span class="string">"vAllowed"</span>));</span><br><span class="line">        vSelfClosingTags = (String[]) conf.get(<span class="string">"vSelfClosingTags"</span>);</span><br><span class="line">        vNeedClosingTags = (String[]) conf.get(<span class="string">"vNeedClosingTags"</span>);</span><br><span class="line">        vDisallowed = (String[]) conf.get(<span class="string">"vDisallowed"</span>);</span><br><span class="line">        vAllowedProtocols = (String[]) conf.get(<span class="string">"vAllowedProtocols"</span>);</span><br><span class="line">        vProtocolAtts = (String[]) conf.get(<span class="string">"vProtocolAtts"</span>);</span><br><span class="line">        vRemoveBlanks = (String[]) conf.get(<span class="string">"vRemoveBlanks"</span>);</span><br><span class="line">        vAllowedEntities = (String[]) conf.get(<span class="string">"vAllowedEntities"</span>);</span><br><span class="line">        stripComment =  conf.containsKey(<span class="string">"stripComment"</span>) ? (Boolean) conf.get(<span class="string">"stripComment"</span>) : <span class="keyword">true</span>;</span><br><span class="line">        encodeQuotes = conf.containsKey(<span class="string">"encodeQuotes"</span>) ? (Boolean) conf.get(<span class="string">"encodeQuotes"</span>) : <span class="keyword">true</span>;</span><br><span class="line">        alwaysMakeTags = conf.containsKey(<span class="string">"alwaysMakeTags"</span>) ? (Boolean) conf.get(<span class="string">"alwaysMakeTags"</span>) : <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        vTagCounts.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">debug</span><span class="params">(<span class="keyword">final</span> String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (vDebug) &#123;</span><br><span class="line">            Logger.getAnonymousLogger().info(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// my versions of some PHP library functions</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">chr</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> decimal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf((<span class="keyword">char</span>) decimal);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">htmlSpecialChars</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>&#123;</span><br><span class="line">        String result = s;</span><br><span class="line">        result = regexReplace(P_AMP, <span class="string">"&amp;amp;"</span>, result);</span><br><span class="line">        result = regexReplace(P_QUOTE, <span class="string">"&amp;quot;"</span>, result);</span><br><span class="line">        result = regexReplace(P_LEFT_ARROW, <span class="string">"&amp;lt;"</span>, result);</span><br><span class="line">        result = regexReplace(P_RIGHT_ARROW, <span class="string">"&amp;gt;"</span>, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * given a user submitted input String, filter out any invalid or restricted</span></span><br><span class="line"><span class="comment">     * html.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input text (i.e. submitted by a user) than may contain html</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> "clean" version of input, with only valid, whitelisted html elements allowed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filter</span><span class="params">(<span class="keyword">final</span> String input)</span> </span>&#123;</span><br><span class="line">        reset();</span><br><span class="line">        String s = input;</span><br><span class="line"></span><br><span class="line">        debug(<span class="string">"************************************************"</span>);</span><br><span class="line">        debug(<span class="string">"              INPUT: "</span> + input);</span><br><span class="line"></span><br><span class="line">        s = escapeComments(s);</span><br><span class="line">        debug(<span class="string">"     escapeComments: "</span> + s);</span><br><span class="line"></span><br><span class="line">        s = balanceHTML(s);</span><br><span class="line">        debug(<span class="string">"        balanceHTML: "</span> + s);</span><br><span class="line"></span><br><span class="line">        s = checkTags(s);</span><br><span class="line">        debug(<span class="string">"          checkTags: "</span> + s);</span><br><span class="line"></span><br><span class="line">        s = processRemoveBlanks(s);</span><br><span class="line">        debug(<span class="string">"processRemoveBlanks: "</span> + s);</span><br><span class="line"></span><br><span class="line">        s = validateEntities(s);</span><br><span class="line">        debug(<span class="string">"    validateEntites: "</span> + s);</span><br><span class="line"></span><br><span class="line">        debug(<span class="string">"************************************************\n\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAlwaysMakeTags</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> alwaysMakeTags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStripComments</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stripComment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">escapeComments</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Matcher m = P_COMMENTS.matcher(s);</span><br><span class="line">        <span class="keyword">final</span> StringBuffer buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String match = m.group(<span class="number">1</span>); <span class="comment">//(.*?)</span></span><br><span class="line">            m.appendReplacement(buf, Matcher.quoteReplacement(<span class="string">"&lt;!--"</span> + htmlSpecialChars(match) + <span class="string">"--&gt;"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        m.appendTail(buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">balanceHTML</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (alwaysMakeTags) &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// try and form html</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            s = regexReplace(P_END_ARROW, <span class="string">""</span>, s);</span><br><span class="line">            s = regexReplace(P_BODY_TO_END, <span class="string">"&lt;$1&gt;"</span>, s);</span><br><span class="line">            s = regexReplace(P_XML_CONTENT, <span class="string">"$1&lt;$2"</span>, s);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// escape stray brackets</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            s = regexReplace(P_STRAY_LEFT_ARROW, <span class="string">"&amp;lt;$1"</span>, s);</span><br><span class="line">            s = regexReplace(P_STRAY_RIGHT_ARROW, <span class="string">"$1$2&amp;gt;&lt;"</span>, s);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// the last regexp causes '&lt;&gt;' entities to appear</span></span><br><span class="line">            <span class="comment">// (we need to do a lookahead assertion so that the last bracket can</span></span><br><span class="line">            <span class="comment">// be used in the next pass of the regexp)</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            s = regexReplace(P_BOTH_ARROWS, <span class="string">""</span>, s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">checkTags</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        Matcher m = P_TAGS.matcher(s);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> StringBuffer buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">while</span> (m.find()) &#123;</span><br><span class="line">            String replaceStr = m.group(<span class="number">1</span>);</span><br><span class="line">            replaceStr = processTag(replaceStr);</span><br><span class="line">            m.appendReplacement(buf, Matcher.quoteReplacement(replaceStr));</span><br><span class="line">        &#125;</span><br><span class="line">        m.appendTail(buf);</span><br><span class="line"></span><br><span class="line">        s = buf.toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// these get tallied in processTag</span></span><br><span class="line">        <span class="comment">// (remember to reset before subsequent calls to filter method)</span></span><br><span class="line">        <span class="keyword">for</span> (String key : vTagCounts.keySet()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> ii = <span class="number">0</span>; ii &lt; vTagCounts.get(key); ii++) &#123;</span><br><span class="line">                s += <span class="string">"&lt;/"</span> + key + <span class="string">"&gt;"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">processRemoveBlanks</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>&#123;</span><br><span class="line">        String result = s;</span><br><span class="line">        <span class="keyword">for</span> (String tag : vRemoveBlanks) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!P_REMOVE_PAIR_BLANKS.containsKey(tag))&#123;</span><br><span class="line">                P_REMOVE_PAIR_BLANKS.putIfAbsent(tag, Pattern.compile(<span class="string">"&lt;"</span> + tag + <span class="string">"(\\s[^&gt;]*)?&gt;&lt;/"</span> + tag + <span class="string">"&gt;"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            result = regexReplace(P_REMOVE_PAIR_BLANKS.get(tag), <span class="string">""</span>, result);</span><br><span class="line">            <span class="keyword">if</span>(!P_REMOVE_SELF_BLANKS.containsKey(tag))&#123;</span><br><span class="line">                P_REMOVE_SELF_BLANKS.putIfAbsent(tag, Pattern.compile(<span class="string">"&lt;"</span> + tag + <span class="string">"(\\s[^&gt;]*)?/&gt;"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            result = regexReplace(P_REMOVE_SELF_BLANKS.get(tag), <span class="string">""</span>, result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">regexReplace</span><span class="params">(<span class="keyword">final</span> Pattern regex_pattern, <span class="keyword">final</span> String replacement, <span class="keyword">final</span> String s)</span> </span>&#123;</span><br><span class="line">        Matcher m = regex_pattern.matcher(s);</span><br><span class="line">        <span class="keyword">return</span> m.replaceAll(replacement);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">processTag</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ending tags</span></span><br><span class="line">        Matcher m = P_END_TAG.matcher(s);</span><br><span class="line">        <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String name = m.group(<span class="number">1</span>).toLowerCase();</span><br><span class="line">            <span class="keyword">if</span> (allowed(name)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!inArray(name, vSelfClosingTags)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (vTagCounts.containsKey(name)) &#123;</span><br><span class="line">                        vTagCounts.put(name, vTagCounts.get(name) - <span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">"&lt;/"</span> + name + <span class="string">"&gt;"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// starting tags</span></span><br><span class="line">        m = P_START_TAG.matcher(s);</span><br><span class="line">        <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String name = m.group(<span class="number">1</span>).toLowerCase();</span><br><span class="line">            <span class="keyword">final</span> String body = m.group(<span class="number">2</span>);</span><br><span class="line">            String ending = m.group(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//debug( "in a starting tag, name='" + name + "'; body='" + body + "'; ending='" + ending + "'" );</span></span><br><span class="line">            <span class="keyword">if</span> (allowed(name)) &#123;</span><br><span class="line">                String params = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> Matcher m2 = P_QUOTED_ATTRIBUTES.matcher(body);</span><br><span class="line">                <span class="keyword">final</span> Matcher m3 = P_UNQUOTED_ATTRIBUTES.matcher(body);</span><br><span class="line">                <span class="keyword">final</span> List&lt;String&gt; paramNames = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                <span class="keyword">final</span> List&lt;String&gt; paramValues = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                <span class="keyword">while</span> (m2.find()) &#123;</span><br><span class="line">                    paramNames.add(m2.group(<span class="number">1</span>)); <span class="comment">//([a-z0-9]+)</span></span><br><span class="line">                    paramValues.add(m2.group(<span class="number">3</span>)); <span class="comment">//(.*?)</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (m3.find()) &#123;</span><br><span class="line">                    paramNames.add(m3.group(<span class="number">1</span>)); <span class="comment">//([a-z0-9]+)</span></span><br><span class="line">                    paramValues.add(m3.group(<span class="number">3</span>)); <span class="comment">//([^\"\\s']+)</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String paramName, paramValue;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> ii = <span class="number">0</span>; ii &lt; paramNames.size(); ii++) &#123;</span><br><span class="line">                    paramName = paramNames.get(ii).toLowerCase();</span><br><span class="line">                    paramValue = paramValues.get(ii);</span><br><span class="line"></span><br><span class="line"><span class="comment">//          debug( "paramName='" + paramName + "'" );</span></span><br><span class="line"><span class="comment">//          debug( "paramValue='" + paramValue + "'" );</span></span><br><span class="line"><span class="comment">//          debug( "allowed? " + vAllowed.get( name ).contains( paramName ) );</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (allowedAttribute(name, paramName)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (inArray(paramName, vProtocolAtts)) &#123;</span><br><span class="line">                            paramValue = processParamProtocol(paramValue);</span><br><span class="line">                        &#125;</span><br><span class="line">                        params += <span class="string">" "</span> + paramName + <span class="string">"=\""</span> + paramValue + <span class="string">"\""</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (inArray(name, vSelfClosingTags)) &#123;</span><br><span class="line">                    ending = <span class="string">" /"</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (inArray(name, vNeedClosingTags)) &#123;</span><br><span class="line">                    ending = <span class="string">""</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ending == <span class="keyword">null</span> || ending.length() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (vTagCounts.containsKey(name)) &#123;</span><br><span class="line">                        vTagCounts.put(name, vTagCounts.get(name) + <span class="number">1</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        vTagCounts.put(name, <span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ending = <span class="string">" /"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"&lt;"</span> + name + params + ending + <span class="string">"&gt;"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// comments</span></span><br><span class="line">        m = P_COMMENT.matcher(s);</span><br><span class="line">        <span class="keyword">if</span> (!stripComment &amp;&amp; m.find()) &#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="string">"&lt;"</span> + m.group() + <span class="string">"&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">processParamProtocol</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        s = decodeEntities(s);</span><br><span class="line">        <span class="keyword">final</span> Matcher m = P_PROTOCOL.matcher(s);</span><br><span class="line">        <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String protocol = m.group(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (!inArray(protocol, vAllowedProtocols)) &#123;</span><br><span class="line">                <span class="comment">// bad protocol, turn into local anchor link instead</span></span><br><span class="line">                s = <span class="string">"#"</span> + s.substring(protocol.length() + <span class="number">1</span>, s.length());</span><br><span class="line">                <span class="keyword">if</span> (s.startsWith(<span class="string">"#//"</span>)) &#123;</span><br><span class="line">                    s = <span class="string">"#"</span> + s.substring(<span class="number">3</span>, s.length());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">decodeEntities</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        StringBuffer buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"></span><br><span class="line">        Matcher m = P_ENTITY.matcher(s);</span><br><span class="line">        <span class="keyword">while</span> (m.find()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String match = m.group(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> decimal = Integer.decode(match).intValue();</span><br><span class="line">            m.appendReplacement(buf, Matcher.quoteReplacement(chr(decimal)));</span><br><span class="line">        &#125;</span><br><span class="line">        m.appendTail(buf);</span><br><span class="line">        s = buf.toString();</span><br><span class="line"></span><br><span class="line">        buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        m = P_ENTITY_UNICODE.matcher(s);</span><br><span class="line">        <span class="keyword">while</span> (m.find()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String match = m.group(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> decimal = Integer.valueOf(match, <span class="number">16</span>).intValue();</span><br><span class="line">            m.appendReplacement(buf, Matcher.quoteReplacement(chr(decimal)));</span><br><span class="line">        &#125;</span><br><span class="line">        m.appendTail(buf);</span><br><span class="line">        s = buf.toString();</span><br><span class="line"></span><br><span class="line">        buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        m = P_ENCODE.matcher(s);</span><br><span class="line">        <span class="keyword">while</span> (m.find()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String match = m.group(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> decimal = Integer.valueOf(match, <span class="number">16</span>).intValue();</span><br><span class="line">            m.appendReplacement(buf, Matcher.quoteReplacement(chr(decimal)));</span><br><span class="line">        &#125;</span><br><span class="line">        m.appendTail(buf);</span><br><span class="line">        s = buf.toString();</span><br><span class="line"></span><br><span class="line">        s = validateEntities(s);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">validateEntities</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>&#123;</span><br><span class="line">        StringBuffer buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// validate entities throughout the string</span></span><br><span class="line">        Matcher m = P_VALID_ENTITIES.matcher(s);</span><br><span class="line">        <span class="keyword">while</span> (m.find()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String one = m.group(<span class="number">1</span>); <span class="comment">//([^&amp;;]*)</span></span><br><span class="line">            <span class="keyword">final</span> String two = m.group(<span class="number">2</span>); <span class="comment">//(?=(;|&amp;|$))</span></span><br><span class="line">            m.appendReplacement(buf, Matcher.quoteReplacement(checkEntity(one, two)));</span><br><span class="line">        &#125;</span><br><span class="line">        m.appendTail(buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> encodeQuotes(buf.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">encodeQuotes</span><span class="params">(<span class="keyword">final</span> String s)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(encodeQuotes)&#123;</span><br><span class="line">            StringBuffer buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            Matcher m = P_VALID_QUOTES.matcher(s);</span><br><span class="line">            <span class="keyword">while</span> (m.find()) &#123;</span><br><span class="line">                <span class="keyword">final</span> String one = m.group(<span class="number">1</span>); <span class="comment">//(&gt;|^)</span></span><br><span class="line">                <span class="keyword">final</span> String two = m.group(<span class="number">2</span>); <span class="comment">//([^&lt;]+?)</span></span><br><span class="line">                <span class="keyword">final</span> String three = m.group(<span class="number">3</span>); <span class="comment">//(&lt;|$)</span></span><br><span class="line">                m.appendReplacement(buf, Matcher.quoteReplacement(one + regexReplace(P_QUOTE, <span class="string">"&amp;quot;"</span>, two) + three));</span><br><span class="line">            &#125;</span><br><span class="line">            m.appendTail(buf);</span><br><span class="line">            <span class="keyword">return</span> buf.toString();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">checkEntity</span><span class="params">(<span class="keyword">final</span> String preamble, <span class="keyword">final</span> String term)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">";"</span>.equals(term) &amp;&amp; isValidEntity(preamble)</span><br><span class="line">                ? <span class="string">'&amp;'</span> + preamble</span><br><span class="line">                : <span class="string">"&amp;amp;"</span> + preamble;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isValidEntity</span><span class="params">(<span class="keyword">final</span> String entity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> inArray(entity, vAllowedEntities);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">inArray</span><span class="params">(<span class="keyword">final</span> String s, <span class="keyword">final</span> String[] array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String item : array) &#123;</span><br><span class="line">            <span class="keyword">if</span> (item != <span class="keyword">null</span> &amp;&amp; item.equals(s)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">allowed</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (vAllowed.isEmpty() || vAllowed.containsKey(name)) &amp;&amp; !inArray(name, vDisallowed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">allowedAttribute</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> String paramName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> allowed(name) &amp;&amp; (vAllowed.isEmpty() || vAllowed.get(name).contains(paramName));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h4 id="web-xml配置filter"><a href="#web-xml配置filter" class="headerlink" title="web.xml配置filter"></a>web.xml配置filter</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>xssFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.devframe.filter.XssFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>xssFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="不进行过滤的请求"><a href="#不进行过滤的请求" class="headerlink" title="不进行过滤的请求"></a>不进行过滤的请求</h4><p>只能使用servlet 的request获取原始的请求，然后 再获取参数，处理，稍微麻烦一下下。</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">------本文结束 🖐 感谢阅读------</div></div></div><div></div><div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> java</a> <a href="/tags/xss/" rel="tag"><i class="fa fa-tag"></i> xss</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/20171213.html" rel="next" title="某一个安静的寒冷的夜晚"><i class="fa fa-chevron-left"></i> 某一个安静的寒冷的夜晚</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/java-stack.html" rel="prev" title="Java的顺序栈和链式栈">Java的顺序栈和链式栈 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><script>window._bd_share_config={common:{bdText:"",bdMini:"1",bdMiniList:!1,bdPic:""},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"},slide:{bdImg:"5",bdPos:"left",bdTop:"100"}}</script><script>with(document)(0)[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)]</script></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="http://oss.wuwii.com/image/head/%E6%97%A0%E9%99%90.jpg" alt="Kai Zhang"><p class="site-author-name" itemprop="name">Kai Zhang</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">192</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">9</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">74</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS </a><a title="收藏到书签，偶尔High一下^_^" rel="alternate external nofollow" class="mw-harlem_shake_slow wobble shake" href="javascript:go()"><i class="fa fa-music"></i> 听音乐</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/kaimz" target="_blank" title="GitHub" rel="external nofollow noopener noreferrer"><i class="fa fa-fw fa-github"></i> GitHub </a></span><span class="links-of-author-item"><a href="mailto:im.zhangk@qq.com" target="_blank" title="Email" rel="external nofollow noopener noreferrer"><i class="fa fa-fw fa-envelope-o"></i> Email </a></span><span class="links-of-author-item"><a href="http://wpa.qq.com/msgrd?v=3&uin=1075199251&site=qq&menu=yes" target="_blank" title="QQ" rel="external nofollow noopener noreferrer"><i class="fa fa-fw fa-qq"></i> QQ</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://weispring.github.io/" title="悦夏" target="_blank" rel="external nofollow noopener noreferrer">悦夏</a></li><li class="links-of-blogroll-item"><a href="http://sdll.club" title="闪电拉拉" target="_blank" rel="external nofollow noopener noreferrer">闪电拉拉</a></li><li class="links-of-blogroll-item"><a href="https://www.draw.io/" title="draw.io" target="_blank" rel="external nofollow noopener noreferrer">draw.io</a></li><li class="links-of-blogroll-item"><a href="https://www.processon.com/" title="processon" target="_blank" rel="external nofollow noopener noreferrer">processon</a></li><li class="links-of-blogroll-item"><a href="http://asciiflow.com/" title="asciiflow" target="_blank" rel="external nofollow noopener noreferrer">asciiflow</a></li><li class="links-of-blogroll-item"><a href="http://hui-wang.info/" title="王辉的博客" target="_blank" rel="external nofollow noopener noreferrer">王辉的博客</a></li><li class="links-of-blogroll-item"><a href="https://leetcode.com/" title="leetcode" target="_blank" rel="external nofollow noopener noreferrer">leetcode</a></li><li class="links-of-blogroll-item"><a href="http://www.lintcode.com/" title="lintcode" target="_blank" rel="external nofollow noopener noreferrer">lintcode</a></li><li class="links-of-blogroll-item"><a href="https://stackoverflow.com/" title="stackoverflow" target="_blank" rel="external nofollow noopener noreferrer">stackoverflow</a></li><li class="links-of-blogroll-item"><a href="http://www.importnew.com/" title="ImportNew" target="_blank" rel="external nofollow noopener noreferrer">ImportNew</a></li><li class="links-of-blogroll-item"><a href="http://ifeve.com/" title="ifeve" target="_blank" rel="external nofollow noopener noreferrer">ifeve</a></li><li class="links-of-blogroll-item"><a href="http://blog.720ui.com/" title="梁桂钊的博客" target="_blank" rel="external nofollow noopener noreferrer">梁桂钊的博客</a></li><li class="links-of-blogroll-item"><a href="http://www.itmuch.com/" title="Spring Cloud|周立" target="_blank" rel="external nofollow noopener noreferrer">Spring Cloud|周立</a></li><li class="links-of-blogroll-item"><a href="https://edu.aliyun.com/" title="阿里云大学" target="_blank" rel="external nofollow noopener noreferrer">阿里云大学</a></li><li class="links-of-blogroll-item"><a href="http://www.iocoder.cn/" title="「芋道源码」" target="_blank" rel="external nofollow noopener noreferrer">「芋道源码」</a></li><li class="links-of-blogroll-item"><a href="http://cmsblogs.com" title="cmsblogs" target="_blank" rel="external nofollow noopener noreferrer">cmsblogs</a></li><li class="links-of-blogroll-item"><a href="http://36kr.com/" title="36氪" target="_blank" rel="external nofollow noopener noreferrer">36氪</a></li><li class="links-of-blogroll-item"><a href="https://laod.cn/" title="老D博客" target="_blank" rel="external nofollow noopener noreferrer">老D博客</a></li><li class="links-of-blogroll-item"><a href="http://blog.didispace.com/" title="程序猿DD" target="_blank" rel="external nofollow noopener noreferrer">程序猿DD</a></li><li class="links-of-blogroll-item"><a href="http://www.bijishequ.com/" title="笔记社区" target="_blank" rel="external nofollow noopener noreferrer">笔记社区</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于XSS攻击"><span class="nav-number">1.</span> <span class="nav-text">关于XSS攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSS漏洞的危害"><span class="nav-number">2.</span> <span class="nav-text">XSS漏洞的危害</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#避免XSS攻击"><span class="nav-number">3.</span> <span class="nav-text">避免XSS攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#XSS过滤器"><span class="nav-number">3.1.</span> <span class="nav-text">XSS过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#request进行XSS过滤"><span class="nav-number">3.2.</span> <span class="nav-text">request进行XSS过滤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XSS过滤工具类"><span class="nav-number">3.3.</span> <span class="nav-text">XSS过滤工具类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#web-xml配置filter"><span class="nav-number">3.4.</span> <span class="nav-text">web.xml配置filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#不进行过滤的请求"><span class="nav-number">3.5.</span> <span class="nav-text">不进行过滤的请求</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 - <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="powered-by" itemprop="copyrightHolder">Kai Zhang</span> <span class="site-pv"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div><div class="powered-by">Hosted by <a href="https://pages.coding.me" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></div><i class="fa fa-bar-chart"></i><div class="theme-info" style="margin-left:8px"><span class="post-count">Site words total count:350.2k</span></div><script type="text/javascript" src="https://zqnight.gitee.io/kaimz.github.io/js/high.js"></script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f62559b2127396ecb27f4ed4f4652ea1":"https://jspassport.ssl.qhimg.com/11.0.1.js?f62559b2127396ecb27f4ed4f4652ea1";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/44968c17.js","daovoice"),daovoice("init",{app_id:"44968c17"}),daovoice("update")</script><script type="text/javascript" src="https://zqnight.gitee.io/kaimz.github.io/js/clipboard.min.js"></script><script type="text/javascript" src="https://zqnight.gitee.io/kaimz.github.io/js/copy.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({model:{jsonPath:"/live2dw/assets/tororo.model.json"},display:{position:"left",width:100,height:200},mobile:{show:!1},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html><!-- rebuild by neat -->